# 데드락 (DeadLock)


데드락이란 **서로 요청한 자원이 이미 상대방에게 점유**되어 다음 명령을 처리 못하는 상태(교착상태)이다. 한정된 자원을 여러 곳에서 사용하려고 할 때 발생한다.


## 발생 조건
데드락은 **4가지 조건을 모두 만족**해야 발생하게 되는데, 하나라도 조건을 만족하지 않으면 문제를 해결할 수 있는 상황이다. 그 조건들은 아래와 같다.

1. **상호 배제 (Mutual Exclusion)**
    - **자원은 한 번에 한 프로세스**만 사용할 수 있음. 사용 중인 자원을 다른 프로세스가 사용하려면 요청한 자원이 해제될 때까지 기다려야 함.

2. **점유 대기 (Hold and wait)**
    - **최소한 하나의 자원을 점유**한 채로 다른 프로세스에 할당되어 있는 자원을 **추가로 점유하기 위해 대기**하는 프로세스가 존재해야 함

3. **비선점 (No Preemption)**
    - 이미 다른 프로세스에 할당된 자원은 사용이 끝날 때까지 **강제로 뺏을 순 없음**

4. **순환 대기 (Circular wait)**
    - 대기중인 프로세스 집합에서 **순환 형태로 자원을 대기**하고 있어야 함

## 데드락을 해결하는 방안

데드락 상황을 해결하기 위한 방안으로는 예방, 회피, 탐지, 회복 이렇게 4가지가 존재한다. 즉, 데드락이 발생하지 않도록 예방하거나, 발생 가능성을 인정하면서도 적절히 회피하거나, 데드락 발생을 완전히 허용하지만 데드락을 탐지하여 회복하는 방안이다.

### 예방 (Prevention)
데드락 발생 조건 중 하나를 제거하며 데드락을 예방하는 방법이다.

* 상호배제 부정 : 여러 프로세스가 **공유 자원 사용 가능**
* 점유대기 부정 : 프로세스 실행 전 **모든 자원을 한 번에 요구**하고 허용할 때까지 작업 보류
* 비선점 부정 : 자원을 점유 중인 높은 우선순위의 프로세스가 다른 자원 요구할 때 **해당 자원 반납**
* 순환대기 부정 : 자원에 고유번호 할당 후 **순서대로 자원 요구**

하지만 이렇게 데드락을 예방하게 되면 시스템의 처리량이나 효율성은 떨어진다. 아래에서 소계하는 데드락 회피법은 예방법보단 조금 덜 제한적인 방법을 활용하여, 예방법의 단점을 일부 해결한다.

### 회피 (Avoidance)

데드락이 발생했을 때 피해나가는 방법이다. 데드락 회피법에서는 안정상태가 핵심 키워드이다. **프로세스들이 요청하는 모든 자원을, 데드락을 발생시키지 않으면서도 차례대로 모두에게 할당해줄 수 있는 상태**라면 이것을 `안정 상태`에 있다고 말한다. 그리고 이처럼, 특정한 순서로 프로세스들에게 자원을 할당하고 실행, 종료 등의 작업을 할 때 **데드락이 발생하지 않는 순서를 찾을 수 있다**면, 그것을 `안전 순서`라고 부른다. 반대로 불안정 상태는 안정 상태가 아닌 상황을 이야기하는데, 즉 데드락이 발생할 수 있는 상황인 것이다.

데드락 회피법은, **자원을 할당한 후에도 시스템이 항상 안정 상태에 있을 수 있도록 할당을 허용하는 것**이 기본 특징이다. 이러한 특징을 살린 대표적인 알고리즘으로 '은행원 알고리즘'이 있다.

{{< admonition >}}
은행원 알고리즘 (Banker's Algorithm)
* 다익스트라가 고안한 알고리즘
* 은행에서 모든 고객의 요구가 충족되도록 현금을 할당하는데서 유래함
* 프로세스가 자원을 요구할 때, 시스템은 **자원을 할당한 후에도 안정 상태로 남아있게 되는지 사전에 검사**하여 데드락 회피
* 안정 상태라면 자원을 할당하고, 아니라면 다른 프로세스들이 자원을 해제할 때까지 대기
{{< /admonition >}}

### 탐지 및 회복(Detection and Recovery)
**자원 할당 그래프**를 통해 데드락을 탐지한다. 즉 자원 요청 시 탐지 알고리즘을 실행시키는 방식으로, 그에 대한 오버헤드가 발생한다. 탐지 기법에 따라 데드락을 발견했다면, 데드락을 일으킨 프로세스를 종료하거나, 할당된 자원을 반납하게끔 하여 데드락 상황을 해결하는 방법이다.

- 프로세스 종료 방법
  - 데드락 발생한 프로세스 모두 정지하는 방식 : 연산중이던 프로세스들이 모두 중단되기 때문에 부분 연산 결과가 폐기될 수 있다.
  - 데드락이 제거될 때까지 하나씩 프로세스 중지하는 방식 : 데드락이 회복되는 시점까지 이를 반복하기 때문에 시스템적으로 고비용 작업이다.

- 자원 선점 시 고려할 점
  - 희생자 선택 (selection of a victim) : 최소의 피해를 줄 수 있는 프로세스를 선택한다.
  - 롤백(rollback) : 선점 된 프로세스를 문제 없던 이전 상태로 롤백해야 한다. 보통 가장 안전한 방법은 프로세스를 중지시키고 재시작하는 것이다.
  - 기아 상태(starvation) : 한 프로세스가 계속 선점되어 기아상태가 되는 것을 방지해야 한다. 한 가지 방법은 우선 순위를 사용하여 선점 될때마다 프로세스 우선순위를 높이는 것이다.

## 참고
https://velog.io/@haero_kim/%EC%82%AC%EB%82%98%EC%9D%B4%EB%93%A4%EC%9D%98-%EC%9E%90%EA%B0%95%EB%91%90%EC%B2%9C-%EB%8D%B0%EB%93%9C%EB%9D%BD-DeadLock

https://yoongrammer.tistory.com/67

